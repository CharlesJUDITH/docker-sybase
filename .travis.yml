env:
  - BASE=centos

sudo: required
services:
  - docker

before_install:
  # Docker Repository
  - export REPO=fjudith/sybase
  # Compute docker tag
  - export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH ; fi`
  - export VERSION=`cat VERSION`

script:
  - set -e
  - docker build -f ${BASE}/Dockerfile -t ${REPO}:${VERSION} {BASE}/
  - docker run -d --name sybase -p 5000:5000 ${REPO}:${VERSION}
  
  - echo "Wait for Sysbase initialization"
  - until nc -vz sybase 5000 > /dev/null 2>1; do printf '.' && sleep 5; done
  - echo " "
  
  - docker logs sybase
  - alias isql="docker exec -it sysbase isql -Usa -PmyPassword -SMYSYBASE -d "master"
  - >-
    cat << EOF | isql
    select name,id from sysobjects
    go
    EOF
after_success: >-
  set -e
  if [[ $TRAVIS_PULL_REQUEST != "false" ]]; then
    echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin &&
    docker tag ${REPO}:${VERSION} ${REPO}:${TAG} &&
    docker push ${REPO}:{TAG}
  fi
